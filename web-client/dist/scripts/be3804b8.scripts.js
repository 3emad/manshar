"use strict";angular.module("webClientApp",["ngCookies","ngResource","ngSanitize","ngRoute","AppConfig","truncate"]).config(["$routeProvider",function(a){var b=function(a){return{load:["$q","$location","LoginService",function(b,c,d){if(d.isAuthorized(a.isPublic)){var e=b.defer();return e.resolve(),e.promise}return b.reject({redirectTo:"/login",previous:c.path()})}]}};a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:b({isPublic:!0})}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl",resolve:b({isPublic:!0})}).when("/signup",{templateUrl:"views/signup.html",controller:"SignupCtrl",resolve:b({isPublic:!0})}).when("/articles/new",{templateUrl:"views/articles/edit.html",controller:"EditArticleCtrl",resolve:b({isPublic:!1})}).when("/articles/:articleId/edit",{templateUrl:"views/articles/edit.html",controller:"EditArticleCtrl",resolve:b({isPublic:!1})}).when("/articles/:articleId",{templateUrl:"views/articles/show.html",controller:"ArticleCtrl",resolve:b({isPublic:!0})}).otherwise({redirectTo:"/"})}]).config(["$httpProvider",function(a){var b=["$location","$q",function(a,b){var c=function(a){return a},d=function(c){return 401===c.status?(a.path("/login"),b.reject(c)):b.reject(c)};return function(a){return a.then(c,d)}}];a.responseInterceptors.push(b),a.defaults.headers.common["Content-Type"]="application/json"}]).run(["$location","$rootScope","LoginService",function(a,b,c){b.page={title:"منشر - منصة النشر العربية"},c.initAuthHeaders(),b.$on("$routeChangeError",function(b,c,d,e){e&&e.redirectTo&&a.path(e.redirectTo).search("prev",e.previous)}),b.$on("$routeChangeSuccess",function(a,c){b.page.title=c.$$route.title||b.page.title})}]),angular.module("AppConfig",[]).constant("ENV","production").constant("API_HOST","api.manshar.me"),angular.module("webClientApp").controller("MainCtrl",["$scope","$location","Article","LoginService",function(a,b,c,d){a.title="منشر",a.tagline="منصة نشر مخصصة بالعربية",a.articles=c.query(),a.isLoggedIn=d.isLoggedIn(),a.newArticle=function(){b.path("/articles/new")},a.showArticle=function(a){b.path("/articles/"+a)}}]),angular.module("webClientApp").controller("ArticleCtrl",["$scope","$routeParams","$location","Article","LoginService",function(a,b,c,d,e){a.isLoggedIn=e.isLoggedIn(),a.article=d.get({articleId:b.articleId}),a.editArticle=function(a){c.path("/articles/"+a+"/edit")}}]),angular.module("webClientApp").controller("EditArticleCtrl",["$rootScope","$scope","$routeParams","$location","Article",function(a,b,c,d,e){var f=!1;b.article={},b.$watch("article.title",function(){a.page.title=b.article.title||"مقال جديد"}),c.articleId&&(f=!0,b.article=e.get({articleId:c.articleId}));var g=function(a){d.path("/articles/"+a.id)},h=function(a){console.log(a)};b.saveArticle=function(a,b){a.published=b,f?e.update({articleId:a.id},{article:a},g,h):e.save({article:a},g,h)}}]),angular.module("webClientApp").controller("LoginCtrl",["$scope","$http","$location","$routeParams","LoginService",function(a,b,c,d,e){a.user={},a.error=null,a.login=function(a){e.login(a,f,g)};var f=function(){c.path(d.prev||"/").search("prev",null)},g=function(){a.error="Wrong username and/or password."}}]),angular.module("webClientApp").controller("SignupCtrl",["$scope","$location","$routeParams","SignupService",function(a,b,c,d){a.user={},a.error=null,a.signup=function(a){d.signup(a,e,f)};var e=function(){b.path(c.prev||"/")},f=function(){a.error="An error occurs."}}]),angular.module("webClientApp").service("ArticleService").factory("Article",["$resource","API_HOST",function(a,b){return a("//"+b+"/api/v1/articles/:articleId",null,{update:{method:"PUT"}})}]),angular.module("webClientApp").service("LoginService",["$http","API_HOST","StorageService",function(a,b,c){var d="//"+b+"/api/v1/";return{isAuthorized:function(a){return a||this.isLoggedIn()},isLoggedIn:function(){return!!c.get("user.email")},login:function(b,c,e){a.post(d+"sessions.json",{user:b}).then(angular.bind(this,function(a){this.storeAuthData(a.data),c&&c(a.data)}),function(a){e&&e(a.data)})},logout:function(b,c){a.delete(d+"sessions.json").then(angular.bind(this,function(a){this.reset(),b&&b(a.data)}),function(a){c&&c(a.data)})},storeAuthData:function(a){c.set("user.email",a.user.email),c.set("user.authToken",a.authToken),this.initAuthHeaders()},initAuthHeaders:function(){var b=c.get("user.authToken");if(b){var d='Token token="'+b+'"';a.defaults.headers.common.Authorization=d}},reset:function(){c.unset("user.email"),c.unset("user.authToken"),a.defaults.headers.common.Authorization=null}}}]),angular.module("webClientApp").service("SignupService",["$http","API_HOST",function(a,b){var c="//"+b+"/api/v1/";return{signup:function(b,d,e){a.post(c+"registrations.json",{user:b}).then(angular.bind(this,function(a){d&&d(a.data)}),function(a){e&&e(a.data)})}}}]),angular.module("webClientApp").service("StorageService",["$window",function(a){return{set:function(b,c){return a.localStorage.setItem(b,c)},get:function(b,c){return a.localStorage.getItem(b)||c},unset:function(b){return a.localStorage.removeItem(b)}}}]),angular.module("webClientApp").directive("mediumEditor",[function(){return{require:"?ngModel",restrict:"A",scope:{placeholder:"@",maxLength:"@",mode:"@"},link:function(a,b,c,d){function e(){var c=b.text().trim(),e=b.html();c===a.placeholder&&(c="",e=""),"rich"!==a.mode?d.$setViewValue(c):d.$setViewValue(e)}new Medium({placeholder:a.placeholder||"",maxLength:a.maxLength||-1,debug:!1,autoHR:!1,mode:a.mode||"rich",element:b[0]}),d&&(d.$render=function(){b.html(d.$viewValue)},b.on("blur keyup change",function(){a.$apply(e)}),e())}}}]),angular.module("webClientApp").filter("nohtml",[function(){return function(a){return String(a).replace(/<(?:.)*?>/gm,"").replace(/(&nbsp;)|(\n)/gm," ")}}]);